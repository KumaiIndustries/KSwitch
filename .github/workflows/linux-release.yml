name: Fix Linux Permissions

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (with leading v), e.g. v1.0.1'
        required: true

jobs:
  fix-perms:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for gh CLI config)
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        uses: cli/cli@v3

      - name: Determine variables
        id: vars
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          ARCH="x64"   # or detect automatically if needed
          ASSET_PATTERN="KSwitch-${TAG}-linux_${ARCH}.tar.gz"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          echo "ASSET=$ASSET_PATTERN" >> $GITHUB_ENV

      - name: Download existing Linux tar.gz
        shell: bash
        run: |
          mkdir artifacts && cd artifacts
          gh release download "$TAG" --pattern "${ASSET}" --repo "${{ env.REPO }}"
          ls -lh

      - name: Extract, chmod +x, and re‚Äêtar
        shell: bash
        run: |
          mkdir unpack
          tar -xzf "$ASSET" -C unpack
          chmod +x unpack/KSwitch
          mv "$ASSET" "${ASSET}.bak"
          tar -czf "$ASSET" -C unpack .
          ls -lh

      - name: Upload fixed tar.gz (overwrite)
        shell: bash
        run: |
          gh release upload "$TAG" "artifacts/$ASSET" --clobber --repo "${{ env.REPO }}"

